---
layout: post
title: "Apache 上面运行 Asp.NET 配置与性能测试"
date: 2009-04-29 07:03
comments: true
categories: 
- .NET
- Apache
- 性能
- 部署
- Web服务器
---
<p>昨天测试了一下在Apache下面部署Asp.NET (3.5)的网站，其实一开始就在想这东西效率应该不会好多少。后面经过多番测试的确是要比IIS慢许多。我是拿公司的项目做的测试，这是一个Web2.0网站，功能还是算比较多，很多种应用都有，除了一开始修改了一点点 Rewrite 以外，其它的功能完全能用，没发现任何问题。</p>
<p><br />先说一下我的安装过程：<br />Apache 的安装我这里就不说了<br /><br />需要下载 <span style="color: #339966;"><strong>mod_aspdotnet</strong></span> 这个 Apache Module<br />项目地址：<a href="http://sourceforge.net/projects/mod-aspdotnet" target="_blank" title="mod_aspdotnet 项目">http://sourceforge.net/projects/mod-aspdotnet</a><br /><br />安装过程很简单，只要选对Apache的安装目录就好了，并且安装程序会自动发现Apache的安装位置的。</p>
<p><span style="font-size: 16px;"><strong><span style="color: #333333;">修改 </span><span style="color: #0000ff;"><span style="color: #333333;">httpd.conf</span> </span></strong><span style="color: #0000ff;"><span style="font-size: 12px;">(<a href="http://pastie.org/461983" target="_blank">source</a>)</span></span><strong><span style="color: #0000ff;"><br /></span></strong></span></p>
<pre class="textmate-source"><pre class="sunburst"><span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># 添加 80 端口的监听(得要把IIS停了，当然也可以换8080或其它，哪么下面的端口号也要跟着改)</span><br />Listen <span class="constant constant_numeric constant_numeric_integer constant_numeric_integer_decimal constant_numeric_integer_decimal_python">80</span><br /><br /><span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># 添加 Module 引用</span><br />LoadModule aspdotnet_module modules<span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>mod_aspdotnet.so<br /><br /><span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># 添加 Handler</span><br />AddHandler asp.net asax ascx ashx asmx aspx axd config cs csproj licx rem resources resx soap vb vbproj vsdisco webinfo<br /><br /><span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># 加入新的 关于 mod_aspdotnet 的 IfModule</span><br /><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span>IfModule mod_aspdotnet.cpp<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />    <span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># For all virtual ASP.NET webs, we need the aspnet_client files</span><br />    <span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># to serve the client-side helper scripts.</span><br />    AliasMatch <span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>aspnet_client<span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>system_web<span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>(\<span class="invalid invalid_illegal invalid_illegal_unexpected-text invalid_illegal_unexpected-text_python">d+)_(\d+)_(\d+)_(\d+)/(.*) "C:/Windows/Microsoft.NET/Framework/v$1.$2.$3/ASP.NETClientFiles/$4"   </span><br />    <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span>Directory <span class="string string_quoted string_quoted_double string_quoted_double_single-line string_quoted_double_single-line_python">"C:/Windows/Microsoft.NET/Framework/v*/ASP.NETClientFiles"</span><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />        Options FollowSymlinks<br />        Order allow,deny<br />        Allow <span class="keyword keyword_control keyword_control_import keyword_control_import_from keyword_control_import_from_python">from</span> <span class="support support_function support_function_builtin support_function_builtin_python">all</span><br />    <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span><span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>Directory<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br /><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span><span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>IfModule<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br /><br /><span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># 配置虚拟主机</span><br />NameVirtualHost <span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">*</span><br /><span class="comment comment_line comment_line_number-sign comment_line_number-sign_python"># tmitter app Config</span><br /><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span>VirtualHost <span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">*</span>:<span class="constant constant_numeric constant_numeric_integer constant_numeric_integer_decimal constant_numeric_integer_decimal_python">80</span><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />    ServerName www.tmitter.us<br /><br />    DocumentRoot D:/<span class="invalid invalid_illegal invalid_illegal_unexpected-text invalid_illegal_unexpected-text_python">work/tmitter</span><br />    AspNetMount <span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span> <span class="string string_quoted string_quoted_double string_quoted_double_single-line string_quoted_double_single-line_python">"D:/work/<span class="constant constant_character constant_character_escape constant_character_escape_tab constant_character_escape_tab_python">t</span>mitter"</span><br /><br />    <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span>Directory <span class="string string_quoted string_quoted_double string_quoted_double_single-line string_quoted_double_single-line_python">"D:/work<span class="constant constant_character constant_character_escape constant_character_escape_backspace constant_character_escape_backspace_python">/tmitter</span>/www"</span><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />        Options Indexes FollowSymLinks Includes ExecCGI <br />        Order allow,deny<br />        AllowOverride All<br />        Allow <span class="keyword keyword_control keyword_control_import keyword_control_import_from keyword_control_import_from_python">from</span> <span class="support support_function support_function_builtin support_function_builtin_python">all</span><br />        DirectoryIndex index.html default.aspx<br />    <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span><span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>Directory<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />   <br /><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span><span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>VirtualHost<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br /><br /><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span>VirtualHost <span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">*</span>:<span class="constant constant_numeric constant_numeric_integer constant_numeric_integer_decimal constant_numeric_integer_decimal_python">80</span><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />    ServerName static.tmitter.us<br />    DocumentRoot D:/<span class="invalid invalid_illegal invalid_illegal_unexpected-text invalid_illegal_unexpected-text_python">work/tmitter/static</span><br />    AspNetMount <span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span> <span class="string string_quoted string_quoted_double string_quoted_double_single-line string_quoted_double_single-line_python">"D:/work<span class="constant constant_character constant_character_escape constant_character_escape_tab constant_character_escape_tab_python">/t</span>mitter/static"</span><br />       <br />    <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span>Directory <span class="string string_quoted string_quoted_double string_quoted_double_single-line string_quoted_double_single-line_python">"D:/work<span class="constant constant_character constant_character_escape constant_character_escape_backspace constant_character_escape_backspace_python">/tmitter</span>/static"</span><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br />        Options FollowSymlinks ExecCGI<br />        Options Indexes FollowSymLinks Includes ExecCGI <br />        Order allow,deny<br />        AllowOverride All<br />        Allow <span class="keyword keyword_control keyword_control_import keyword_control_import_from keyword_control_import_from_python">from</span> <span class="support support_function support_function_builtin support_function_builtin_python">all</span><br />        DirectoryIndex index.html default.aspx<br />    <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span><span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>Directory<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span>   <br /><span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&lt;</span><span class="keyword keyword_operator keyword_operator_arithmetic keyword_operator_arithmetic_python">/</span>VirtualHost<span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_python">&gt;</span><br /></pre>
</pre>
<p>&nbsp;</p>
<p><br /><span style="font-size: 16px;"><strong>配置本地域名解析 hosts 文件</strong></span><br />打开 <span style="color: #0000ff;">c:\windows\system32\drivers\etc\hosts</span> 这个文件，并加入</p>
<p style="padding:15px; background:#F0F0F0; font-size:12px;">127.0.0.1&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; www.tmitter.us<br />127.0.0.1&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; static.tmitter.us</p>
<p>最后保存，这里名字和解析的细节跟据自已需求修改。<br /><br />最后保存重启 Apache，重启过程会有些慢，估计是在编译 Asp.net 程序。完成后，打开 http://www.tmitter.us就可以看到效果了。<br /><br /><strong><span style="font-size: 16px;">性能测试</span></strong></p>
<p>我用的是公司的项目，这里面有使用 <a href="http://www.danga.com/memcached/" target="_blank">Memcached</a> 做页面缓存的，但从 Url 请求到 <a href="http://www.danga.com/memcached/" target="_blank">Memcached</a> 取数据中间还有一些逻辑，现在我开着缓存测试，结果是差距很明显。</p>
<p style="padding:15px; background:#F0F0F0; font-size:12px;">ab -n 2000 -c 200 http://www.tmitter.us/</p>
<p>&nbsp;</p>
<p><span style="font-size: 16px;"><span style="color: #ff0000;"><strong>Apache 测试结果：</strong></span></span></p>
<p style="padding:15px; font-size:12px; background:#F0F0F0;">Server Software:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Apache/2.2.9<br />Server Hostname:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; www.ytrip.com.tw<br />Server Port:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80<br /><br />Document Path:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /<br />Document Length:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28316 bytes<br /><br />Concurrency Level:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 200<br />Time taken for tests:&nbsp;&nbsp; 17.922 seconds<br />Complete requests:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2000<br />Failed requests:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />Write errors:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />Total transferred:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 57240000 bytes<br />HTML transferred:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 56632000 bytes<br />Requests per second:&nbsp;&nbsp;&nbsp; 111.60 [#/sec] (mean)<br />Time per request:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1792.188 [ms] (mean)<br />Time per request:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8.961 [ms] (mean, across all concurrent requests)<br />Transfer rate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3119.01 [Kbytes/sec] received<br /><br />Connection Times (ms)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; min&nbsp; mean[+/-sd] median&nbsp;&nbsp; max<br />Connect:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; 2.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 16<br />Processing:&nbsp;&nbsp;&nbsp; 31 1782 3108.0&nbsp;&nbsp;&nbsp; 313&nbsp;&nbsp; 11484<br />Waiting:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 16 1772 3101.9&nbsp;&nbsp;&nbsp; 313&nbsp;&nbsp; 11469<br />Total:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31 1783 3108.0&nbsp;&nbsp;&nbsp; 313&nbsp;&nbsp; 11484<br /><br />Percentage of the requests served within a certain time (ms)<br />&nbsp; 50%&nbsp;&nbsp;&nbsp; 313<br />&nbsp; 66%&nbsp;&nbsp;&nbsp; 516<br />&nbsp; 75%&nbsp;&nbsp;&nbsp; 797<br />&nbsp; 80%&nbsp;&nbsp; 4484<br />&nbsp; 90%&nbsp;&nbsp; 9016<br />&nbsp; 95%&nbsp;&nbsp; 9453<br />&nbsp; 98%&nbsp; 10781<br />&nbsp; 99%&nbsp; 11031<br />&nbsp;100%&nbsp; 11484 (longest request)</p>
<p><span style="font-size: 16px;"><strong><span style="color: #008000;">IIS 测试结果：</span></strong></span></p>
<p style="padding:15px;font-size:12px; background:#F0F0F0;">Server Software:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Microsoft-IIS/6.0<br />Server Hostname:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; www.ytrip.com.tw<br />Server Port:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80<br /><br />Document Path:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /<br />Document Length:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28316 bytes<br /><br />Concurrency Level:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 200<br />Time taken for tests:&nbsp;&nbsp; 1.344 seconds<br />Complete requests:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2000<br />Failed requests:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />Write errors:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />Total transferred:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 57184000 bytes<br />HTML transferred:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 56632000 bytes<br />Requests per second:&nbsp;&nbsp;&nbsp; 1488.37 [#/sec] (mean)<br />Time per request:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 134.375 [ms] (mean)<br />Time per request:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.672 [ms] (mean, across all concurrent requests)<br />Transfer rate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 41558.14 [Kbytes/sec] received<br /><br />Connection Times (ms)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; min&nbsp; mean[+/-sd] median&nbsp;&nbsp; max<br />Connect:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; 2.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 16<br />Processing:&nbsp;&nbsp;&nbsp; 63&nbsp; 125&nbsp; 16.5&nbsp;&nbsp;&nbsp; 125&nbsp;&nbsp;&nbsp;&nbsp; 156<br />Waiting:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 47&nbsp; 119&nbsp; 18.2&nbsp;&nbsp;&nbsp; 125&nbsp;&nbsp;&nbsp;&nbsp; 141<br />Total:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 63&nbsp; 125&nbsp; 16.5&nbsp;&nbsp;&nbsp; 125&nbsp;&nbsp;&nbsp;&nbsp; 156<br /><br />Percentage of the requests served within a certain time (ms)<br />&nbsp; 50%&nbsp;&nbsp;&nbsp; 125<br />&nbsp; 66%&nbsp;&nbsp;&nbsp; 141<br />&nbsp; 75%&nbsp;&nbsp;&nbsp; 141<br />&nbsp; 80%&nbsp;&nbsp;&nbsp; 141<br />&nbsp; 90%&nbsp;&nbsp;&nbsp; 141<br />&nbsp; 95%&nbsp;&nbsp;&nbsp; 141<br />&nbsp; 98%&nbsp;&nbsp;&nbsp; 141<br />&nbsp; 99%&nbsp;&nbsp;&nbsp; 141<br />&nbsp;100%&nbsp;&nbsp;&nbsp; 156 (longest request)</p>
<p>&nbsp;</p>
