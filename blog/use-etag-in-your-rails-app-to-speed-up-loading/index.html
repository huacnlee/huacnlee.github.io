
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
  <head>
    <!-- include head -->
    

<meta charset="utf-8">
<title>在你的 Rails App 中开启 ETag 加速页面载入同时节省资源 - 李华顺</title>
<meta name="author" content="Jason Lee">
<meta name="description"
      content="在你的 Rails App 中开启 ETag 加速页面载入同时节省资源 什么是 ETag 网上关于 ETag 的解释有很多，我这里简单的说明一下我的理解： ETag 是 HTTP 协议的标准参数，一般是这样的：&#8221;686897696a7c876b7e&#8221; 一段字符， &hellip;">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="no">
<meta content='True' name='HandheldFriendly' />
<link rel="canonical" href="http://huacnlee.github.com/blog/use-etag-in-your-rails-app-to-speed-up-loading">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css"
      media="screen, projection"
      rel="stylesheet"
      type="text/css">

<script src="/javascripts/modernizr-2.0.js" type="text/javascript"></script>
<script src="/javascripts/ender.js" type="text/javascript"></script>
<script src="/javascripts/octopress.js" type="text/javascript"></script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-9745660-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
      '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <!-- /include -->
  </head>
  <body>
    <div id="wrapper">

      <header role="banner" class="site_metas">
	<!-- include header -->
	
<hgroup>
  <h1><a href="/">李华顺</a></h1>
  
  <div class="nav">
    <a href="/">About</a> /
    <a href="/work">Work</a> /
    <a href="/blog/archives">Blog</a> /
    <a href="https://github.com/huacnlee">GitHub</a>
  </div>
</hgroup>

	<!-- /include -->
        <!-- include social_service_links -->
	
        <!-- /include -->
      </header>

      <div id="content">
	<!-- content -->
	


<article class="entry" role="article">

  <header>
    <h1 class="entry_title">在你的 Rails App 中开启 ETag 加速页面载入同时节省资源</h1>
    
  </header>

  <div class="entry_content"><h2>什么是 ETag</h2>

<p>网上关于 <a href="http://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> 的解释有很多，我这里简单的说明一下我的理解：</p>

<blockquote><p>ETag 是 HTTP 协议的标准参数，一般是这样的：&#8221;686897696a7c876b7e&#8221; 一段字符，它能通过一段字符来判断浏览器 cache 的内容是否和服务端返回的内容是否相同，从而来决定是否要重新从服务器下载东西 (HTTP 状态 200 - 重新下载 / 304 - 没有更新)。</p></blockquote>

<h2>ETag 使用场景举例</h2>

<p><strong>这个东西非常适合用于动态内容上面，以减少不必要的 HTML 下载，达到加速的目的。</strong></p>

<p>比如下面这个场景的例子：</p>

<ol>
<li>用户访问 /topics/11 页面，<code>TopicsController#show</code> 加载 <code>@topic</code>，并通过 View 生成内容返回</li>
<li>用户来回访问 10 次 /topics/11，可此页面内容无任何变化</li>
<li>过了1天以后，<code>@topic</code> 有了新的回复，用户再次访问的时候，内容变了</li>
</ol>


<p>上面的场景用户一共访问了 12 次 /topics/11 这个页面，但只有第一次和最后一次才有实质性的内容需要下载的，可在没有 ETag 的情况下面，服务器执行和浏览器下载都是有 12 次，其中的 10 次是多余的。</p>

<p>如果加上 ETag 以后，将会是这样：</p>

<ol>
<li>用户访问 /topics/11 页面，<code>TopicsController#show</code> 加载 <code>@topic</code>，并通过 View 生成内容返回，并给出目前内容的 <code>ETag: 89vbsn28716</code></li>
<li>用户带着 <code>ETag: 89vbsn28716</code> 再次访问 /topics/11 ，服务器检查 ETag 与执行结果，发现无变化，返回 304，浏览器直接使用 Cache 的内容渲染页面</li>
<li>过了一天以后，<code>@topic</code> 有了新回复，用户再次带着 <code>ETag: 89vbsn28716</code> /topics/11，服务器检查 ETag 发现不对了，生成新内容，并返回 200</li>
</ol>


<p>这个过程中，服务端执行了 12 次页面，而下载 HTML 内容到本地却只有两次。</p>

<h2>Rails 里面开启 ETag</h2>

<p>Rails 的 ActionController 里面已经为我们提供了 <a href="http://api.rubyonrails.org/classes/ActionController/ConditionalGet.html#method-i-fresh_when">fresh_when</a> 和  <a href="http://api.rubyonrails.org/classes/ActionController/ConditionalGet.html#method-i-stale-3F">stale?</a> 这两个方法用于处理 ETag，可以点击连接稍微看一下说明。</p>

<p>我下面以 <a href="http://ruby-china.org">Ruby China</a> 的 <a href="http://ruby-china.org/wiki/install_ruby_guide">查看 Wiki 页面</a> 为例子演示如何在 Rails 里面合理的使用 ETag</p>

<p>pages_controller.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@page</span> <span class="o">=</span> <span class="no">Page</span><span class="o">.</span><span class="n">find_by_slug</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@comments</span> <span class="o">=</span> <span class="vi">@page</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fresh_when</span><span class="p">(</span><span class="ss">:etag</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="vi">@page</span><span class="p">,</span> <span class="vi">@comments</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>加上 <code>fresh_when</code> 方法以后，Rails 将会用 <code>@page</code> 和 <code>@comments</code> 内容的组合的 MD5 hash 值作为 ETag 并与 HTTP Headers 里面的 ETag 进行比较来决定是否需要执行后面的 Views 渲染，并返回 <code>200</code> 或 <code>304</code>。</p>

<p>在浏览器上面显示将会是这样：</p>

<p>没有 ETag 的情况 (72 ms)：</p>

<p><a href="http://www.flickr.com/photos/huacnlee/8280251122/" title="200 by 李华顺, on Flickr"><img src="http://farm9.staticflickr.com/8493/8280251122_b2bf1ee3fa_o.png" width="913" height="737" alt="200"></a></p>

<p>有 ETag 的情况 (40 ms)：</p>

<p><a href="http://www.flickr.com/photos/huacnlee/8280250976/" title="304 by 李华顺, on Flickr"><img src="http://farm9.staticflickr.com/8487/8280250976_5bdd0405bb_o.png" width="913" height="737" alt="304"></a></p>

<p>OMG! 页面加载速度直接提升了 <strong>46%</strong>，并且 ETag 命中的情况下，Views 上面的一系列代码都不用执行了，节省了不少资源。</p>

<h3>但是实际的场景，往往没有上面这个例子这么简单&#8230;&#8230;</h3>

<p>比如，页面上有 <code>current_user</code> 的状态，页脚的 HTML 代码是通过 <code>Setting.footer_html</code> 出来的，Head 里面还有 <code>Setting.custom_heads</code> 出来的代码。</p>

<p>以上这些东西都是需要影响页面更新的。</p>

<p>实际上我们只需要将 <code>fresh_when</code> 方法在 <code>ApplicationController</code> 里面覆盖一下，把页面上需要调用而影响结果的东西加入到 <code>fresh_when</code> 的 <code>:etag</code> 参数里面就好了:</p>

<p>application_controller.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">fresh_when</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="c1"># 保证 etag 参数是 Array 类型</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]]</span> <span class="k">if</span> <span class="o">!</span><span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">].</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># 加入页面上直接调用的信息用于组合 etag</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">current_user</span>
</span><span class='line'>  <span class="c1"># Config 的某些信息</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="no">SiteConfig</span><span class="o">.</span><span class="n">app_name</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="no">SiteConfig</span><span class="o">.</span><span class="n">custom_head_html</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="no">SiteConfig</span><span class="o">.</span><span class="n">footer_html</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="no">SiteConfig</span><span class="o">.</span><span class="n">google_analytics_key</span>
</span><span class='line'>  <span class="c1"># 所有 etag 保持一天</span>
</span><span class='line'>  <span class="n">opts</span><span class="o">[</span><span class="ss">:etag</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">current</span>
</span><span class='line'>  <span class="k">super</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样一来，每个用户的 ETag 都是不同的，当用户登出和登录以后，页面的内容将会呈现不同的 ETag，同时当你修改 SiteConfig 的某些内容是，ETag 也会随着改变，这样一来 ETag 的引入就不会影响到页面更新了。</p>

<p>实际上你可以大量的使用 <code>fresh_when</code> 方法在你的动态页面上面，来减少 Rails View 的执行与 HTML 下载，只要好好分析，将页面上需要的内容加入到 <code>:etag</code> 参数里面就好了。</p>

<p>比如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="vi">@hot_topics</span> <span class="o">=</span> <span class="no">Topic</span><span class="o">.</span><span class="n">hot</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@hot_users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">hot</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@hot_nodes</span> <span class="o">=</span> <span class="no">Node</span><span class="o">.</span><span class="n">hot</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@recent_topics</span> <span class="o">=</span> <span class="no">Topic</span><span class="o">.</span><span class="n">recent</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fresh_when</span><span class="p">(</span><span class="ss">:etag</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="vi">@hot_topics</span><span class="p">,</span><span class="vi">@hot_users</span><span class="p">,</span><span class="vi">@hot_nodes</span><span class="p">,</span><span class="vi">@recent_topics</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



</div>

  <footer>
    <p class="meta">

      

      
      <time datetime="2012-12-17 11:29:00 +0800" pubdate>2012-12-17</time>
      

      
      <span class="categories">
	<a class='category' href='/blog/category/etag/'>ETag</a>, <a class='category' href='/blog/category/rails/'>Rails</a>, <a class='category' href='/blog/category/web-开发/'>Web 开发</a>
      </span>
      

    </p>

    
    <div class="sharing">

      

      

      
    </div>
    

    
    <section>
      <h3 id="comments">Comments</h3>
      <div id="disqus_thread" aria-live="polite">
	<noscript>
	  Javascript not support.
	  (<a href="http://disqus.com/?ref_noscript">Disqus</a>)
	</noscript>
      </div>
    </section>
    

  </footer>

</div>

	<!-- /content -->
      </div>

      <footer role="contentinfo">
	<!-- include footer -->
	<p>
  Copyright &copy; 2019 - Jason Lee
</p>

	<!-- /include -->
      </footer>

      <!-- include after_footer -->
      

<script type="text/javascript">
      var disqus_shortname = 'huacnlee';
      
	
	// var disqus_developer = 1;
	var disqus_identifier = 'http://huacnlee.github.com/blog/use-etag-in-your-rails-app-to-speed-up-loading';
	var disqus_url = 'http://huacnlee.github.com/blog/use-etag-in-your-rails-app-to-speed-up-loading';
	var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




      <!-- /include -->

    </div>
  </body>
</html>
